# КРИТИЧЕСКИЕ ПРАВИЛА (НАРУШЕНИЕ НЕДОПУСТИМО)

## 1. ОБЯЗАТЕЛЬНАЯ ВАЛИДАЦИЯ ПЕРЕД ЗАВЕРШЕНИЕМ

**CRITICAL: ALWAYS выполняй этот чеклист перед ответом пользователю:**

- [ ] Проверил ли я индекс ugrep (`bash scripts/check-ugrep-index.sh`)?
- [ ] Использовал ли я `ugrep "персонаж/концепция" ru/` для проверки консистентности?
- [ ] Соответствует ли текст профилю персонажа из главы книги?
- [ ] Проверил ли я технические детали через `ugrep "технология" ru/science/`?
- [ ] Если запускал агентов — передал ли им инструкции про ugrep из секции 4?
- [ ] Плавное ли повествование (НЕ рваные предложения)?
- [ ] Выполнил ли я `~/quarto/bin/quarto render --to html` после правок?

**Если хоть один пункт НЕТ — исправь перед ответом.**

---

## 1.1 АВТОМАТИЧЕСКАЯ ИНДЕКСАЦИЯ UGREP (CRITICAL!)

**ПЕРЕД началом работы ВСЕГДА проверяй индекс:**

```bash
# Проверка и автообновление индекса
bash scripts/check-ugrep-index.sh
```

**Правила индексации:**
- Индекс обновляется автоматически раз в 12 часов
- Время последней индексации хранится в `.ugrep-index-timestamp`
- НИКОГДА не пропускай проверку индекса
- При изменении файлов вручную: `ugrep-indexer .`

**Правила поиска:**
- ВСЕГДА используй `ugrep` для поиска в ru/science/ и ru/book/
- НЕ используй Read/Grep для широкого поиска - ТОЛЬКО ugrep
- Для простых вопросов пользователя тоже используй ugrep

---

## 2. СТИЛЬ ПОВЕСТВОВАНИЯ (CRITICAL)

### NEVER:
- **НЕ** писать рваными короткими предложениями
- **НЕ** разделять каждое предложение пустой строкой
- **НЕ** изобретать альтернативные объяснения техники (проверяй через ugrep!)
- **НЕ** использовать Read/Grep для широкого поиска - ТОЛЬКО ugrep
- **НЕ** пропускать проверку индекса перед работой

### ALWAYS:
- Плавная проза, длинные связные предложения с подчинёнными конструкциями
- Сверяться с ru/science/ через `ugrep` перед написанием технических деталей
- Диалоги встроены в повествование (без лишних пустых строк)

**Плохо (рвано):**
```
Доктор наук. В двадцать два года. Он знал только один случай.
```

**Хорошо (плавно):**
```
Доктор наук в двадцать два года — Валерий знал в истории только один такой случай, и тот произошёл задолго до его рождения, в пятьдесят втором году.
```

---

## 3. РАБОЧИЙ ПРОЦЕСС (MUST FOLLOW)

**Последовательность действий:**

0. **ПЕРЕД началом работы:**
   ```bash
   bash scripts/check-ugrep-index.sh
   ```
   → Проверка и обновление индекса

1. **Перед написанием сцены с персонажем:**
   ```bash
   ugrep "имя персонажа" ru/book/
   ```
   → Читаю как персонаж ведёт себя в других главах

2. **Перед добавлением технических деталей:**
   ```bash
   ugrep "название технологии" ru/science/
   ```
   → Проверяю канон (зеркала, энергомост, масс-драйвер, etc.)

3. **После ЛЮБЫХ правок в `.qmd` файлах:**
   ```bash
   ~/quarto/bin/quarto render --to html
   ```
   → ОБЯЗАТЕЛЬНО. БЕЗ вопросов. НЕ открывать новую вкладку.

---

## 4. РАБОТА С АГЕНТАМИ (CRITICAL!)

**ВАЖНО: При запуске агентов (Task tool с Explore/Plan) ВСЕГДА передавай им инструкции про ugrep.**

### Обязательный блок для промпта агента:

```
КРИТИЧНО: Используй ugrep для индексированного поиска.

Причина: ugrep имеет встроенную индексацию, быстрый и не нагружает CPU.

Команды для поиска:
- Персонажи: `ugrep "имя персонажа" ru/book/`
- Техника: `ugrep "технология" ru/science/`
- Физика: `ugrep "концепция" ru/science/physics.qmd`

Альтернатива: используй Grep tool (для Claude Code) или Read для прямого чтения.
```

### Шаблоны промптов для агентов:

**Анализ сюжета:**
```
Проанализируй сюжетную структуру книги.

ОБЯЗАТЕЛЬНО используй ugrep для поиска:
- Главы: ugrep "глава" ru/book/
- Персонажи: ugrep "Валерий" ru/book/
- Техника: ugrep "зеркала" ru/science/

Или используй Grep tool если в Claude Code.
```

**Проверка консистентности персонажа:**
```
Проверь, соответствует ли сцена характеру персонажа [ИМЯ].

ОБЯЗАТЕЛЬНО:
1. ugrep "[имя персонажа]" ru/book/
2. Читай результаты поиска
3. Сравни поведение в сцене с другими главами
```

**Добавление технических деталей:**
```
Добавь описание технологии [НАЗВАНИЕ] в главу.

ОБЯЗАТЕЛЬНО:
1. ugrep "[технология]" ru/science/physics.qmd
2. Используй ТОЛЬКО канонические объяснения из результатов
3. НЕ изобретай альтернативные механизмы
```

---

## 5. ФОРМАТ ТЕКСТА

### Абзацы
- Пустая строка = смена сцены или значительная пауза
- Объединять: диалог + описание действия, несколько реплик

### Диалоги
```markdown
Валерий усмехнулся. — И что делать? Рыбачить?

— Почему бы и нет?
```

### Структура главы
```markdown
# Название главы {.unnumbered}

**Место. Время.**

Текст...

---

## Подзаголовок секции
```

### Картинки
`![](images/filename.png)` (без подписей)

### Диаграммы
- **ВСЕГДА** используй Mermaid для flowcharts, sequence diagrams, графов
- Формат: ` ```{mermaid} `
- Типы: `flowchart TD`, `flowchart LR`, `sequenceDiagram`, `graph`
- Используй `subgraph` для вложенных блоков
- **НЕ** использовать ASCII-art для диаграмм

---

## 6. СПРАВОЧНАЯ БАЗА (используй ugrep для доступа)

**CRITICAL: НЕ придумывай детали. ВСЕГДА проверяй через ugrep или Grep.**

### Команды поиска:

```bash
# Персонажи (в главах книги)
ugrep "Валерий" ru/book/
ugrep "Королёв" ru/book/

# Техника (в научной документации)
ugrep "зеркала" ru/science/
ugrep "энергомост" ru/science/
ugrep "масс-драйвер" ru/science/

# Расчёты
ugrep "КПД" ru/science/calculations/
ugrep "масса" ru/science/calculations/
```

### Для Claude Code:
Используй Grep tool:
- `Grep pattern="персонаж" path="ru/book/"`
- `Grep pattern="технология" path="ru/science/"`

### Обновление индекса:
После изменений обнови индекс:
```bash
ugrep-indexer .
```

### Структура проекта:

```
ru/
├── book/                    # Главы книги
│   ├── 00-prologue/
│   ├── 01-kabinety/
│   ├── ...
│   └── 11-merkury/
│
├── science/                 # Техническая документация
│   ├── physics.qmd          # Физика проекта (КАНОН)
│   ├── robots.qmd           # Бестиарий роботов
│   ├── factory.qmd          # Завод "Точка Ноль"
│   ├── risks.qmd            # Риски и ограничения
│   ├── calculations/        # Технические расчёты
│   │   ├── energy.qmd
│   │   ├── railgun.qmd
│   │   ├── budget.qmd
│   │   └── ...
│   └── data/
│       └── constants.qmd    # Константы и справочные данные
│
└── index.qmd                # Главная страница
```

---

## 7. ПЕРЕД ЗАВЕРШЕНИЕМ ЗАДАЧИ

**STOP. Пройди чеклист из секции 1.**

Если пропустил хоть один пункт — вернись и исправь.
